
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>A Working Introduction to Crypto with PyCrypto - (cons 'hack *life*)</title>
  <meta name="author" content="Kyle Isom">

  
  <meta name="description" content="Introduction Recently at work I have been using the
PyCrypto libraries quite a bit.
The documentation is pretty good, but there are a few areas that &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kisom.github.com/blog/2011/06/17/intro-to-crypto">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="(cons 'hack *life*)" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=IM+Fell+English' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">(cons 'hack *life*)</a></h1>
  
    <h2>my commit log as a blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kisom.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Me</a></li>
  <li><a href="http://www.coderwall.com/kisom/">Coderwall</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">A Working Introduction to Crypto With PyCrypto</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-17T16:15:00+03:00" pubdate data-updated="true">Jun 17<span>th</span>, 2011</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h2>Introduction</h2>

<p>Recently at work I have been using the
<a href="https://www.dlitz.net/software/pycrypto/">PyCrypto</a> libraries quite a bit.
The documentation is pretty good, but there are a few areas that took me a bit
to figure out. In this post, I&#8217;ll be writing up a quick overview of the
PyCrypto library and cover some general things to know when writing
cryptographic code in general. I&#8217;ll go over symmetric, public-key, hybrid,
and message authentication codes. Keep in mind this is a quick introduction and
a lot of gross simplifications are made. For a more complete introduction to
cryptography, take a look at the references at the end of this article. This
article is just an appetite-whetter - if you have a real need for information
security you should hire an expert. Real data security goes beyond this quick
introduction (you wouldn&#8217;t trust the design and engineering of a bridge to
a student with a quick introduction to civil engineering, would you?)</p>

<p>Some quick terminology: for those unfamiliar, I introduce the following terms:</p>

<ul>
<li><strong>plaintext</strong>: the original message</li>
<li><strong>ciphertext</strong>: the message after cryptographic transformations are applied
to obscure the original message.</li>
<li><strong>encrypt</strong>: producing ciphertext by applying cryptographic transformations
to plaintext.</li>
<li><strong>decrypt</strong>: producing plaintext by applying cryptographic transformations to
ciphertext.</li>
<li><strong>cipher</strong>: a particular set of cryptographic transformations providing means
of both encryption and decryption.</li>
<li><strong>ciphersystem</strong>: a set of cryptographic transformations that take a large input and
transform it to a unique (typically fixed-size) output. For hashes to be
cryptographically secure, collisions should be practically nonexistent. It
should be practically impossible to determine the input from the output.</li>
</ul>


<p>Cryptography is an often misunderstood component of information security, so
an overview of what it is and what role it plays is in order. There are four
major roles that cryptography plays:</p>

<ul>
<li><strong>confidentiality</strong>: ensuring that only the intended recipients receive the
plaintext of the message.</li>
<li><strong>data integrity</strong>: the plaintext message arrives unaltered.</li>
<li><strong>entity authentication</strong>: the identity of the sender is verified. An entity
may be a person or a machine.</li>
<li><strong>message authentication</strong>: the message is verified as having been
unaltered.</li>
</ul>


<p>Note that cryptography is used to obscure the contents of a message and verify
its contents and source. It will <strong>not</strong> hide the fact that two entities are
communicating.</p>

<p>There are two basic types of ciphers: symmetric and public-key ciphers. A
symmetric key cipher employs the use of shared secret keys. They also tend to
be much faster than public-key ciphers. A public-key cipher is so-called because
each key consists of a private key which is used to generate a public key. Like
their names imply, the private key is kept secret while the public key is
passed around. First, I&#8217;ll take a look at a specific type of symmetric ciphers:
block ciphers.</p>

<h2>Block Ciphers</h2>

<p>There are two further types of symmetric keys: stream and block ciphers. Stream
ciphers operate on data streams, i.e. one byte at a time. Block ciphers operate
on blocks of data, typically 16 bytes at a time. The most common block cipher
and the standard one you should use unless you have a very good reason to use
another one is the <a href="https://secure.wikimedia.org/wikipedia/en/wiki/Advanced_Encryption_Standard">AES</a>
block cipher, also documented in <a href="http://csrc.nist.gov/publications/fips/fips197/fips-197.pdf">FIPS PUB 197</a>.
AES is a specific subset of the Rijndael cipher. AES uses block size of
128-bits (16 bytes); data should be padded out to fit the block size - the
length of the data block must be multiple of the block size. For example,
given an input of <code>ABCDABCDABCDABCD ABCDABCDABCDABCD</code> no padding would
need to be done. However, given <code>ABCDABCDABCDABCD ABCDABCDABCD</code> an
additional 4 bytes of padding would need to be added. A common padding scheme
is to use <code>0x80</code> as the first byte of padding, with <code>{0x00</code> bytes
filling out the rest of the padding. With padding, the previous example would
look like: <code>ABCDABCDABCDABCD ABCDABCDABCD\x80\x00\x00\x00</code>.</p>

<p>Writing a padding function is pretty easy:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">pad_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="c"># return data if no padding is required</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">data</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># subtract one byte that should be the 0x80</span>
</span><span class='line'>  <span class="c"># if 0 bytes of padding are required, it means only</span>
</span><span class='line'>  <span class="c"># a single \x80 is required.</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">padding_required</span>     <span class="o">=</span> <span class="mi">15</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\x80</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">data</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="n">padding_required</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">data</span>
</span></code></pre></td></tr></table></div></figure>


<p>Similarly, removing padding is also easy:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">unpad_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>  <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">data</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x80</span><span class="s">&#39;</span><span class="p">:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">data</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;ve included these functions in the <a href="http://kisom.github.com/downloads/crypto_intro_example.tar.gz">example code</a>
for this tutorial.</p>

<p>Encryption with a block cipher requires selecting a
<a href="https://secure.wikimedia.org/wikipedia/en/wiki/Block_cipher_modes_of_operation">block mode</a>.
By far the most common mode used is <strong>cipher block chaining</strong> or
<em>CBC</em> mode. Other modes include <strong>counter (CTR)</strong>,
<strong>cipher feedback (CFB)</strong>, and the extremely insecure
<strong>electronic codebook (ECB)</strong>. CBC mode is the standard and is
well-vetted, so I will stick to that in this tutorial. Cipher block chaining
works by XORing the previous block of ciphertext with the current block. You
might recognise that the first block has nothing to be XOR&#8217;d with; enter the
<em><a href="https://secure.wikimedia.org/wikipedia/en/wiki/Initialization_vector">initialisation vector</a></em>.
This comprises a number of randomly-generated bytes of data the same
size as the cipher&#8217;s block size. This initialisation vector should random
enough that it cannot be recovered; one manner of doing this is to combine a
standard UNIX timestamp with a block-size group of random data, using a standard
hashing algorithm such as MD5 to make it unique.</p>

<p>One of the most critical components to encryption is properly generating
random data. Fortunately, most of this is handled by the PyCrypto library&#8217;s
<code>Crypto.Random.OSRNG module</code>. You should know that the more entropy sources
available (such as network traffic and disk activity), the faster the system
can generate cryptographically-secure random data. I&#8217;ve written a function that
can generate a <em><a href="https://secure.wikimedia.org/wikipedia/en/wiki/Cryptographic_nonce">nonce</a></em>
suitable for use as an initialisation vector. This will work on a UNIX machine;
the comments note how easy it is to adapt it to a Windows machine. This
function requires a version of PyCrypto at least 2.1.0 or higher.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">Crypto.Random.OSRNG.posix</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">generate_nonce</span><span class="p">():</span>
</span><span class='line'>  <span class="n">rnd</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Random</span><span class="o">.</span><span class="n">OSRNG</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">new</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rnd</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
</span><span class='line'>  <span class="n">nonce</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Hash</span><span class="o">.</span><span class="n">MD5</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">rnd</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">nonce</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>I will note here that the python <code>random</code> module is completely unsuitable for
cryptography (as it is completely deterministic). You shouldn&#8217;t use it for
cryptographic code.</p>

<p>Symmetric ciphers are so-named because the key is shared across any entities.
There are three key sizes for AES: 128-bit, 192-bit, and 256-bit, aka 16-byte,
24-byte, and 32-byte key sizes. If you want to use a passphrase, you
should use a digest algorithm that produces an appropriately sized digest, and
hash that passphrase. For example, for AES-256, you would want to use SHA-256.
Here is a sample function to generate an AES-256 key from a passphrase:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># generate an AES-256 key from a passphrase</span>
</span><span class='line'><span class="k">def</span> <span class="nf">passphrase</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">readable</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
</span><span class='line'>  <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd"> Converts a passphrase to a format suitable for use as an AES key.</span>
</span><span class='line'>
</span><span class='line'><span class="sd"> If readable is set to True, the key is output as a hex digest. This is</span>
</span><span class='line'><span class="sd"> suitable for sharing with users or printing to screen when debugging</span>
</span><span class='line'><span class="sd"> code.</span>
</span><span class='line'>
</span><span class='line'><span class="sd"> By default readable is set to False, in which case the value it </span>
</span><span class='line'><span class="sd"> returns is suitable for use directly as an AES-256 key.</span>
</span><span class='line'><span class="sd"> &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="n">key</span>     <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Hash</span><span class="o">.</span><span class="n">SHA256</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">readable</span><span class="p">:</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>We could include this a set of AES encryption and decryption functions:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">mode</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span>       <span class="c"># shortcut to clean up code</span>
</span><span class='line'>
</span><span class='line'><span class="c"># AES-256 encryption using a passphrase</span>
</span><span class='line'><span class="k">def</span> <span class="nf">passphrase_encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">key</span>     <span class="o">=</span> <span class="n">passphrase</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span>    <span class="o">=</span> <span class="n">pad_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="n">aes</span>     <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">aes</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># AES-256 decryption using a passphrase</span>
</span><span class='line'><span class="k">def</span> <span class="nf">passphrase_decrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">key</span>     <span class="o">=</span> <span class="n">passphrase</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span class='line'>  <span class="n">aes</span>     <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span>    <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">unpad_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how the data is padded before being encrypted and unpadded after
decryption - the decryption process will not remove the padding on its own.</p>

<p>Unless you are you doing interactive encryption passphrase encryption won&#8217;t be
terribly useful. Instead, we just need to generate 32 random bytes (and make
sure we keep track of it) and use that as the key:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># generate a random AES-256 key</span>
</span><span class='line'><span class="k">def</span> <span class="nf">generate_aes_key</span><span class="p">():</span>
</span><span class='line'>  <span class="n">rnd</span>     <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Random</span><span class="o">.</span><span class="n">OSRNG</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">new</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">KEY_SIZE</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">rnd</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use this key directly in the AES transformations:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">aes</span>     <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span>    <span class="o">=</span> <span class="n">pad_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">aes</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">aes</span>     <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span>    <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">unpad_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>That should cover the basics of block cipher encryption. We&#8217;ve gone over key
generation, padding, and encryption / decryption. AES-256 isn&#8217;t the only
block cipher provided by the PyCrypto package, but again: it is the standard
and well vetted.</p>

<h2>ASCII-Armouring</h2>

<p>I&#8217;m going to take a quick detour and talk about ASCII armouring. If you&#8217;ve
played with the crypto functions above, you&#8217;ll notice they produce an annoying
dump of binary data that can be a hassle to deal with. One common technique for
making the data a little bit easier to deal with is to encode it with
<a href="https://secure.wikimedia.org/wikipedia/en/wiki/Base64">base64</a>. There
are a few ways to incorporate this into python:</p>

<h3>Absolute Base64 Encoding</h3>

<p>The easiest way is to just base64 encode everything in the encrypt function.
Everything that goes into the decrypt function should be in base64 - if it&#8217;s
not, the <code>base64</code> module will throw an error: you could catch this and
then try to decode it as binary data.</p>

<h3>A Simple Header</h3>

<p>A slightly more complex option, and the one I adopt in this article, is to use
a <code>x00</code> as the first byte of the ciphertext for binary data, and to use
<code>\x41</code> (an ASCII &#8221;<code>A</code>&#8221;) for ASCII encoded data. This will increase
the complexity of the encryption and decryption functions slightly. We&#8217;ll also
pack the initialisation vector at the beginning of the file as well. Given now
that the <code>iv</code> argument might be <code>None</code> in the decrypt function, I
will have to rearrange the arguments a bit; for consistency, I will move it in
both functions. I leave adding it into the <code>passphrase_encrypt</code> and
<code>passphrase_decrypt</code> functions as an exercise for the reader. My modified
functions look like this now:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">armour</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
</span><span class='line'>  <span class="n">aes</span>     <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span>    <span class="o">=</span> <span class="n">pad_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="n">ct</span>      <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>         <span class="c"># ciphertext</span>
</span><span class='line'>  <span class="n">ct</span>      <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">ct</span>                   <span class="c"># pack the initialisation vector in</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># ascii-armouring</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">armour</span><span class="p">:</span>
</span><span class='line'>      <span class="n">ct</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x41</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">encodestring</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>      <span class="n">ct</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">ct</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">ct</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iv</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
</span><span class='line'>  <span class="c"># remove ascii-armouring if present</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span class='line'>  <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x41</span><span class="s">&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">decodestring</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">iv</span>      <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span>
</span><span class='line'>  <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
</span><span class='line'>  <span class="n">aes</span>     <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span>    <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">unpad_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>A More Complex Container</h3>

<p>There are more complex ways to do it (and you&#8217;ll see it with the public keys
in the next section) that involve putting the base64 into a container of sorts
that contains additional information about the key.</p>

<h2>Public Key Cryptography</h2>

<p>Now it is time to take a look at public-key cryptography. Public-key
cryptography, or PKC, involves the use of two-part keys. The private key is
the sensitive key that should be kept private by the owning entity, whereas the
public key (which is generated from the private key) is meant to be distributed
to any entities which must communicate securely with the entity owning the
private key. Confusing? Let&#8217;s look at this using the venerable Alice and Bob,
patron saints of cryptography.</p>

<p>Alice wants to talk to Bob, but doesn&#8217;t want Eve to know the contents of the
message. Both Alice and Bob generate a set of private keys. From those private
keys, they both generate public keys. Let&#8217;s say they post their public keys on
their websites. Alice wants to send a private message to Bob, so she looks up
Bob&#8217;s public key from his site. (In fact, there is a way to distribute keys via
a central site or entity; this is called a public key infrastructure (PKI). The
public key can be used as the key to encrypt a message with PKC. The resulting
ciphertext can only be decrypted using Bob&#8217;s private key. Alice sends Bob the
resulting ciphertext, which Eve cannot decrypt without Bob&#8217;s private key.
Hopefully this is a little less confusing.</p>

<p>One of the most common PKC systems is RSA (which is an acronym for the last
names of the designers of the algorithm). Generally, RSA keys are 1024-bit,
2048-bit, or 4096-bits long. The keys are most often in
<a href="https://secure.wikimedia.org/wikipedia/en/wiki/Privacy-enhanced_Electronic_Mail">PEM</a>
or
<a href="https://secure.wikimedia.org/wikipedia/en/wiki/Distinguished_Encoding_Rules">DER</a>
format. Generating RSA keys with PyCrypto is extremely easy:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">generate_key</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
</span><span class='line'>  <span class="n">PRNG</span>    <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Random</span><span class="o">.</span><span class="n">OSRNG</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">new</span><span class="p">()</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>  <span class="n">key</span>     <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">PublicKey</span><span class="o">.</span><span class="n">RSA</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">PRNG</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">key</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>key</code> that is returned isn&#8217;t like the keys we used with the block ciphers:
it is an RSA object and comes with several useful built-in methods. One of
these is the <code>size()</code> method, which returns the size of the key in bits minus
one. For example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">publickey</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="n">publickey</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span> <span class="mi">1024</span> <span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span><span class='line'><span class="mi">1023</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>A quick note: I will use 1024-bit keys in this tutorial because they are
faster to generate, but in practice you should be using at least 2048-bit
keys. The key also includes encryption and decryption methods in the class:
\begin{verbatim}</p>

<pre><code>&gt;&gt;&gt; import publickey
&gt;&gt;&gt; import base64
&gt;&gt;&gt; message = 'Test message...'
&gt;&gt;&gt; ciphertext = key.encrypt(message, None)
&gt;&gt;&gt; print base64.encodestring(ciphertext[0])
gzA9gXfHqnkValdhhYjRVVSxuygx48i66h0vFUnmVu8FZXJtmaACvNDo43D0vjjHzFiblE1eCFiI
xlhVuHxldWXJSnARgWX1bTY7imR9Hve+WQC8rl+qB5xpq3xnKH7/z8/5YdLvCo/knXYE1cI/XYJP
EP1nA6bUZNj6bD1Zx4w=
</code></pre>

<p>\end{verbatim}</p>

<p>The \texttt{None} that is passed into the encryption function is part of the
PyCrypto API for those publickey ciphers requiring an additional random number
function to be passed in. It returns a tuple containing only the encrypted
message. In order to pass this to the decryption function, we need to pass only
the encrypted message as a string:
\begin{verbatim}</p>

<pre><code> &gt;&gt;&gt; ciphertext = key.encrypt(message, None)[0]
 &gt;&gt;&gt; key.decrypt(ciphertext)
 'Test message...'
</code></pre>

<p>\end{verbatim}</p>

<p>While these are simple enough, we could put them into a pair of functions that
also include ASCII-armouring:
\begin{verbatim}</p>

<pre><code>def encrypt(key, message, armour = True):
    ciphertext  = key.encrypt( message, None )
    ciphertext  = ciphertext[0]

    if armour:
        ciphertext = '\x41' + base64.encodestring( ciphertext )
    else:
        ciphertext = '\x00' + base64.encodestring( ciphertext )

    return ciphertext

def decrypt(key, message):
    if   '\x00' == message[0]:
        message = message[1:]
    elif '\x41' == message[0]:
        message == base64.decodestring( message[1:] )

    plaintext   = key.decrypt( message )
    return plaintext
</code></pre>

<p>\end{verbatim}</p>

<p>These two functions present a common API that will simplify encryption and
decryption and make it a little easier to read. Assuming we still have the same
\texttt{message} definition as before:
\begin{verbatim}</p>

<pre><code>&gt;&gt;&gt; ciphertext = publickey.encrypt(key, message)
&gt;&gt;&gt; publickey.decrypt(key, ciphertext)
'Test message...'
</code></pre>

<p>\end{verbatim}</p>

<p>Now, what if we want to export this generated key and read it in later? The key
comes with the method \verb|exportKey()|. If the key is a private key, it will
export the private key; if it is a public key, it will export the public key.
We can write functions to backup our private key (which \textbf{absolutely}
needs to be kept secure) and a function to export our public key, suitable for
uploading to our web page or to a PKI keystore:
\begin{verbatim}</p>

<pre><code># backup our key, whether public or private
def export_key(filename, key):
    try:
        f = open(filename, 'w')
    except IOError as e:
        print e
        raise
    else:
        f.write( key.exportKey() )
        f.close()

# will only export the public key
def export_pubkey(filename, key):
    try:
        f = open(filename, 'w')
    except IOError as e:
        print e
        raise
    else:
        f.write( key.publickey().exportKey() )
        f.close()
</code></pre>

<p>\end{verbatim}</p>

<p>Importing a key is done using the RSA.importKey function:
\begin{verbatim}</p>

<pre><code>def load_key(filename):
    try:
        f = open(filename)
    except IOError as e:
        print e
        raise
    else:
        key = Crypto.PublicKey.RSA.importKey(f.read())
        f.close()
    return key
</code></pre>

<p>\end{verbatim}</p>

<p>We can take a look at the difference between the public and private keys:
\begin{verbatim}</p>

<pre><code>&gt;&gt;&gt; key = publickey.generate_key( 1024 )
&gt;&gt;&gt; print key.exportKey()
-----BEGIN RSA PRIVATE KEY-----
MIICXAIBAAKBgQCpVA2pqLuS1fmutvx/lBhlk+UMXWcZKVzh+n5D6Hv/ZWhlzRuC
q408uhVBUD32ylbQ2iFdhA1leq0xWRGQ8Y3LlO6tQZ0gC2oOHetX3YOghO3q4yMe
wvuU+Wb6bS1aRDc9YV3IMPjQW47MOROUldjMEdJJhfxko5YZuaghhpd56wIDAQAB
AoGAaRznellnT2iLHX00U1IwruXXOwzEUmdN5G4mcathRhLCcueXW095VqhBR5Ez
Vf8XU4EFU1MFKei0mLys3ehFV4aoTfU1xm91jXNZrM/rIjHQQObx2fcDSgrM9iyd
kcgGrz5nDvsyxAxOwxCh96vNxZZYTWa8Zcqng1XYeW93nFkCQQC8Rqwn9Sa1UjBB
mIepkcdYfflkzmD7IBcgiTmGFQ9NXiehY6MQd0UJoFYGBEknPazzWQbNVpkZO4TR
oPuKNjSNAkEA5jyWJhKyq2BVD6UP77vYTJu48OhLx4J7qb3DKHnk5syOBnbke2Df
KV1VjRsipSjb4EXAWhWaqnTfPPDbvyWWVwJAWUgSP2iLkJSG+bRBMPJGW/pxF5Ke
fre6/9zTAHhgJ0os9OVw4FAO1v/Hi1bg8dDXgRaImTsloseMtnPmlKYbyQJAbmbr
EQKyTl95KnFaPPj0dXfOrSaW/+pf5jsqlAQvcUTxbcQhN9Bx8mHhHjK+4DfBh7+q
xwfJDKfSTGSq2vPpLQJBAL5irIeHoFESPZZI1NW7OkpKPcO/2ps9NkhgZJQ7Pc11
lWh6Ch2cnBzZmeh6lN/zC4l3mLVhdZSXkEKOzeuFpBs=
-----END RSA PRIVATE KEY-----
&gt;&gt;&gt; pk = key.publickey()
&gt;&gt;&gt; print pk.exportKey()
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCpVA2pqLuS1fmutvx/lBhlk+UM
XWcZKVzh+n5D6Hv/ZWhlzRuCq408uhVBUD32ylbQ2iFdhA1leq0xWRGQ8Y3LlO6t
QZ0gC2oOHetX3YOghO3q4yMewvuU+Wb6bS1aRDc9YV3IMPjQW47MOROUldjMEdJJ
hfxko5YZuaghhpd56wIDAQAB
-----END PUBLIC KEY-----
</code></pre>

<p>\end{verbatim}</p>

<p>Using the \verb|export_pubkey()| function, you can pass that file
around to people to encrypt messages to you. Often, you wil want to generate a
keypair to give to people. One convention is to name the secret key
&#8216;keyname.prv&#8217; (prv for private) and the public key &#8216;keyname.pub&#8217;. We will
follow that convention in an \verb|export_keypair()| function:
\begin{verbatim}</p>

<pre><code>def export_keypair(basename, key):
    pubkeyfile   = basename + '.pub'
    prvkeyfile   = basename + '.prv'

    export_key(prvkeyfile, key)
    export_pubkey(pubkeyfile, key)
</code></pre>

<p>\end{verbatim}</p>

<p>For example, Bob generates a keypair and emails the public key to Alice:
\begin{verbatim}</p>

<pre><code> &gt;&gt;&gt; key = publickey.generate_key( 1024 )
 &gt;&gt;&gt; key.size()
 1023
 &gt;&gt;&gt; key.has_private()
 True
 &gt;&gt;&gt; publickey.export_keypair('bob.prv', key)
 &gt;&gt;&gt; 
</code></pre>

<p>\end{verbatim}</p>

<p>Then, Assuming Bob gave Alice \verb|bob.pub|:
\begin{verbatim}</p>

<pre><code>&gt;&gt;&gt; bob = publickey.load_key('./bobpub')
&gt;&gt;&gt; message = 'secret message from Alice to Bob'
&gt;&gt;&gt; print publickey.encrypt(bob, message)
AN6RsuXEeKicUZKtZCsDeqGKeB5em+NG/bgoqr9l8ij2o1Gr9sT69tv0zxgmigK/Jt+gPxg/EDu61
nHmAK0XQV7BvJS5jLuBxdJ0mEpysVClu46XN1KHU2l2DsGht9e8OFvhEfDkI5t/cy/gXr0xz/EUi
rqo8qLd9Mw6TerM8gs8=
</code></pre>

<p>\end{verbatim}</p>

<p>The ASCII-armoured format makes it convenient for Alice to paste the encrypted
message to Bob, so she does, and now Bob has it on his computer. To read it, he
does something similar:
\begin{verbatim}</p>

<pre><code>&gt;&gt;&gt; bob = publickey.load_key('tests/bob.prv')
&gt;&gt;&gt; print publickey.decrypt(bob, message)
secret message from Alice to Bob
</code></pre>

<p>\end{verbatim}</p>

<p>At this point, Bob can&#8217;t be sure that the message came from Alice but he can
read the message. We&#8217;ll cover entity authentication in a later section, but
first, there&#8217;s something else I&#8217;d to point out:</p>

<p>You might have noticed at this point that public key cryptography appears to
be a lot simpler than symmetric key cryptography. The key distribution problem
is certainly easier, especially with a proper PKI. Why would anyone choose to
use symmetric key cryptography over public key cryptography? The answer is
performance: if you compare the block cipher test code (if you don&#8217;t have a
copy of this code, you can get it at the tutorial&#8217;s
github page\footnote{https://www.github.com/kisom/crypto_tutorial}) with the public
key test code, you will notice that the block cipher code is orders of magnitude
faster - and it generates far more keys than the public key code. There is a
solution to this problem: hybrid cryptosystems.</p>

<p>Hybrid cryptosystems use public key cryptography to establish a symmetric
session key. Both \textbf{TLS}\footnote{https://secure.wikimedia.org/wikipedia/en/wiki/Transport_Layer_Security}
(Transport Layer Security), and its predecessor \textbf{SSL} (Secure Sockets
Layer), most often used to secure HTTP transactions, use a hybrid cryptosystem
to speed up establishing a secure session. PGP (and hence GnuPG) also uses
hybrid crypto.</p>

<p>Let&#8217;s say Alice and Bob wish to use hybrid crypto; if Alice initiates the
session, she should be the one to generate the session key. For example,
\begin{verbatim}</p>

<pre><code> &gt;&gt;&gt; import block, publickey
 &gt;&gt;&gt; session_key = block.generate_aes_key()
 &gt;&gt;&gt; alice_key   = publickey.load_key('keys/alice.prv')
 &gt;&gt;&gt; bob_key     = publickey.load_key('keys/bob.pub')
 &gt;&gt;&gt; encrypted_session_key = encrypt( bob_key, session_key )
</code></pre>

<p>\end{verbatim}</p>

<p>At this point, Alice should send Bob the \verb|encrypted_session_key|; she
should retain a copy as well. They can then use this key to communicate using
the much-faster AES256.</p>

<p>In communicating, it might be wise to create a message format that packs in
the session key into a header, and encrypts the rest of the body with the
session key. This is a subject beyond the realm of a quick tutorial - again,
consult with the people who do this on a regular basis.</p>

<p>\section{Digital Signatures}
In all of the previous examples, we assumed that the identity of the sender
wasn&#8217;t a question. For a symmetric key, that&#8217;s less of a stretch - there&#8217;s no
differentiation between owners. Public keys, however, are supposed to be
associated with an entity. How can we prove the identity of the user? Without
delving into too much into social sciences and trust metrics and a huge
philosophical argument, let&#8217;s look at the basics of signatures.</p>

<p>A signature works similarly to encryption, but it in reverse, and it is slightly
different: a hash of the message is &#8216;encrypted&#8217; by the private key to the
public key. The public key is used to &#8216;decrypt&#8217; this ciphertext. Contrast this
to actual public key encryption: the entire message is encrypted to the private
key by the public key, and the private key is used to decrypt the ciphertext.
With signatures, the &#8216;encrypted&#8217; hash of the message is called the signature,
and the act of &#8216;encryption&#8217; is termed &#8216;signing&#8217;. Similarly, the &#8216;decryption&#8217;
is known as verification or verifying the signature.</p>

<p>PyCrypto&#8217;s PublicKey implementations already come with signatures and
verification methods for keys using sign() and verify(). The signature
is a long in a tuple:
\begin{verbatim}</p>

<pre><code>&gt;&gt;&gt; key.sign( d, None )
(1738423518152671545669571445860037944518162197656333123466248015147955424248
</code></pre>

<p>876723731383711018550231967374810686606623315483033485630977014574359346192927942
623807461783144628656796225504478196458051789241311033020911767301220653148276004
0551357526383627059382081878791040169815009051016949220178044764130908L,)
\end{verbatim}</p>

<p>We can write our own functions to wrap around these two functions and perform
ASCII-armouring if desired. Our signature function should take a key and a
message (and optionally a flag to ASCII armour the signature), and sign a
digest of the message:
\begin{verbatim}</p>

<pre><code>def sign(key, message, armour = True):
    if not key.can_sign(): 
        return None

    digest      = Crypto.Hash.SHA256.new(message).digest()
    signature   = key.sign( digest, None )[0]

    if armour:
        sig     = base64.encodestring( str(signature) )
    else:
        sig     = str( signature )

    return sig.strip()
</code></pre>

<p>\end{verbatim}</p>

<p>The signature is converted to a string to make it easier to pack it into
structures and also to give us consistent input to the verify() function.</p>

<p>Verifying the signature requires that we determine if the signature is ASCII-
armoured or not, then comparing a digest of the message to the signature:
\begin{verbatim}</p>

<pre><code>def verify(key, message, signature):
    try:
        sig     = long( signature )
    except ValueError as e:
        sig     = long( base64.decodestring( signature.rstrip('\n') ), )

    digest      = Crypto.Hash.SHA256.new(message).digest()
    return key.verify( digest, (sig, ) )
</code></pre>

<p>\end{verbatim}</p>

<p>The sign() function returns a signature and the verify() function returns a
boolean. Now, Alice can sign her message to Bob, and Bob knows the key belongs
to Alice. She sends Bob the signature and the encrypted message. Bob then makes
sure Alice&#8217;s key properly verifies the signature to the encrypted message.</p>

<p>\section{Key Exchange}
So how does Bob know the key actually belongs to Alice? There are two main
schools of thought regarding the authentication of key ownership: centralised
and decentralised. TLS/SSL follow the centralised school: a root
certificate\footnote{A certificate is a public key encoded with X.509 and which
can have additional informational attributes attached, such as organisation
name and country.} authority (CA) signs intermediary CA keys, which then sign
user keys. For example, if Bob runs Foo Widgets, LLC, he can generate an SSL
keypair. From this, he generates a certificate signing request, and sends this
to the CA. The CA, usually after taking some money and ostensibly actually
verifying Bob&#8217;s identity\footnote{The extent to which this actually happens
varies widely based on the different CAs.}, then signs Bob&#8217;s certificate. Bob
sets up his webserver to use his SSL certificate for all secure traffic, and
Alice sees that the CA did in fact sign his certificate. This relies on trusted
central authorities, like VeriSign\footnote{There is some question as to whether
VeriSign can actually be trusted, but that is another discussion for another
day&#8230;} Alice&#8217;s web browser would ship with a keystore of select trusted CA
public keys (like VeriSigns) that she could use to verify signatures on the
certificates from various sites. This system is called a public key
infrastructure.</p>

<p>The other school of thought is followed by PGP (and GnuPG) - the
decentralised model. In PGP, this is manifested as the Web of
Trust\footnote{http://www.rubin.ch/pgp/weboftrust.en.html}.
For example, if Carol now wants to talk to Bob and gives Bob her public key,
Bob can check to see if Carol&#8217;s key has been signed by anyone else. We&#8217;ll also
say that Bob knows for a fact that Alice&#8217;s key belongs to Alice, and he trusts
her\footnote{It is quite often important to distinguish between
\textit{I know this key belongs to that user} and \textit{I trust that user}.
This is especially important with key signatures - if Bob cannot trust Alice to
properly check identities, she might sign a key for an identity she hasn&#8217;t
checked.}, and that Alice has signed Carol&#8217;s key. Bob sees Alice&#8217;s signature on
Carol&#8217;s key and then can be reasonably sure that Carol is who she says it was.
If we repeat the process with Dave, whose key was signed by Carol (whose key
was signed by Alice), Bob might be able to be more certain that the key belongs
to Dave, but maybe he doesn&#8217;t really trust Carol to properly verify identities.
In PGP, Bob can mark keys as having various trust levels, and from this a web
of trust emerges: a picture of how well you can trust that a given key belongs
to a given user.</p>

<p>The key distribution problem is not a quick and easy problem to solve; a lot of
very smart people have spent a lot of time coming up with solutions to the
problem. There are key exchange protocols (such as the Diffie-Hellman key
exchange\footnote{http://is.gd/Tr0zLP}
and IKE\footnote{https://secure.wikimedia.org/wikipedia/en/wiki/Internet_Key_Exchange}
(which uses Diffie-Hellman) that provide alternatives to the web of trust and
public key infrastructures.</p>

<p>\section{References}
\begin{itemize}
  \item A. J. Menezes, P. C. van Oorschot, and S. A. Vanstone. \textit{The Handbook of Applied Cryptography}, CRC Press, 5th printing, October 1996.</p>

<p>  \item B. Schneier. \textit{Applied Cryptography, Second Edition}, John Wiley and Sons, 1996.</p>

<p>  \item PyCrypto API Documentation. https://www.dlitz.net/software/pycrypto/apidoc/</p>

<p>\end{itemize}</p>

<p>\end{document}</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Kyle Isom</span></span>

      








  


<time datetime="2011-06-17T16:15:00+03:00" pubdate data-updated="true">Jun 17<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cryptography/'>cryptography</a>, <a class='category' href='/blog/categories/introduction/'>introduction</a>, <a class='category' href='/blog/categories/python/'>python</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://kisom.github.com/blog/2011/06/17/intro-to-crypto/" data-via="kyleisom" data-counturl="http://kisom.github.com/blog/2011/06/17/intro-to-crypto/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/05/29/starting-ocaml/" title="Previous Post: starting ocaml">&laquo; starting ocaml</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/07/04/rgtdd/" title="next Post: RGTDD">RGTDD &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/01/23/basic-set-theory/">Basic Set Theory</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/18/on-sopa-and-pipa/">on SOPA and PIPA</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/02/back-to-lisp/">back to lisp</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/31/my-docs-got-dropped/">my docs got dropped</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/03/suddenly-enlightenment/">suddenly enlightenment</a>
      </li>
    
  </ul>
</section>
<!-- 
    from http://mizzy.org/blog/2012/01/13/coderwall-badges-on-the-sidebar/
    tweaked by kisom
-->

<section>
<h1>Coderwall</h1>
  <p>
  <script type="text/javascript">
    function display_coderwall(args) {
        var badges = args["data"]["badges"];
        for ( var i = 0; i < badges.length; i++ ) {
            var alt = badges[i]["name"] + ': ' + badges[i]["description"];
            var img = '<img src="' + badges[i]["badge"] + '"';
            img = img + ' width="48" height="48" title="' + alt + '" />';
            document.write(img);
        }
    }
  </script>
  <script src="http://coderwall.com/kisom.json?callback=display_coderwall"></script>
  </p>
  <p style="text-align: right;"><a href="http://coderwall.com/kisom">Powered by coderwall.com</a></p>
</section>


<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/kisom">@kisom</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'kisom',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("kyleisom", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/kyleisom" class="twitter-follow-button" data-show-count="false">Follow @kyleisom</a>
  
</section>


<section>
  <h1>My Pinboard</h1>
  <ul id="pinboard_linkroll">Fetching linkroll...</ul>
  <p><a href="http://pinboard.in/u:kyleisom">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "kyleisom"; //id target for pinboard list
  var pinboard_count = 3; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>


<section class="lastfm">
<h1>Recently Scrobbled</h1>
<style type="text/css">
  #lastfmList li{ text-align: left; }
</style>
<ul id="lastfmList">
  <li class="loading">Updating tracks...</li>
</ul>

<script type="text/javascript">
  $.domReady(function(){
    getLastfmFeed("brokenlcd", 10, "263f6cbb10c41a73ea3d3fb3fb2f942e");
  });
</script>

<script lang="Javascript">
function getLastfmFeed(user,count,api_key) {
  count = parseInt(count, 10);
  $.ajax({
      url: "http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=" + user + "&limit=" + count + "&api_key=" + api_key
    , type: 'xml'
    , error: function (err) { $('#lastfmList li.loading').addClass('error').text("Last.fm's busted"); }
    , success: function(data) { showLastfmFeed(data); }
  });
}

function showLastfmFeed(xml){
  var tracklist = document.getElementById('lastfmList'),
      content = '',
      i=0;
  
  $(xml.responseXML).find("recenttracks").children().each(function(){
    var artist = $(this).find('artist').text(),
        name = $(this).find('name').text(),
        date = $(this).find('date').text(),
        url = $(this).find('url').text(),
        img = $(this).find('image').text(),
        artist_url = url.replace(/_\/[\w\+]+\/?$/, '');
        content += '<li id="lastfmItem_'+i+'"><img src="' + img + '" width="24" height="24"> <a href="'+ url + '">' + name +'</a> by <a href="' + artist_url + '">' + artist + '</a><span class="date"> ' + prettyDate(date) + ' ago</span></li>';
    i+=1;
  });

  tracklist.innerHTML = content;
}
</script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Kyle Isom -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'conshacklife';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://kisom.github.com/blog/2011/06/17/intro-to-crypto/';
        var disqus_url = 'http://kisom.github.com/blog/2011/06/17/intro-to-crypto/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
